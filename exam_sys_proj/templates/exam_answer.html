<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>考试答题</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='layui/css/layui.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/teacher.css') }}">
    <script type="text/javascript" src="{{ url_for('static', filename='jquery/jquery.js') }}" charset="utf-8"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='layui/layui.js') }}" charset="utf-8"></script>
    <style>
        .question-section {
            margin-bottom: 20px;
        }

        .question-content {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div class="layui-container">
    <div class="layui-row">
        <div class="layui-col-md12">
            <h1 class="layui-text-center">{{ paper["main_content"] }}</h1>
            <div id="questions"></div>
            <button class="layui-btn layui-btn-normal" onclick="submitAnswers()">提交答案</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/layui@2.5.7/dist/layui.all.js"></script>
<script>
    var paper = {{ paper|safe }};
    var answers = [];

    // 渲染试题
    function renderQuestions() {
        var questionsDiv = document.getElementById('questions');
        paper.questions.forEach((question, index) => {
            if (typeof question === 'string') {
                let section = document.createElement('div');
                section.className = 'question-section';
                section.innerHTML = `<div style="display:flex;font-size:3vw;margin-left: 1vw;font-weight: bold">${question}</div>`;
                questionsDiv.appendChild(section);
            } else {
                let questionDiv = document.createElement('div');
                questionDiv.className = 'question-content';
                questionDiv.innerHTML = `
                    <p style="display:flex;font-size:2vw;margin-left: 1vw;margin-top: 0.5vw;">${question.main_content}</p>
                    ${renderOptions(question, index)}
                `;
                questionsDiv.appendChild(questionDiv);
            }
        });
    }

    // 渲染选项
    function renderOptions(question, index) {
        let optionsHtml = '';
        if (question.type === '选择题' || question.type === '判断题') {
            question.questions.forEach((option, optionIndex) => {
                optionsHtml += `
                    <div style="display: flex;flex-direction: row"">
                        <input type="radio" name="question_${index}" value="${option}" style="margin-top: 0.5vw;height: 1.25vw;width: 1.25vw">
                        <label style="display:flex;font-size:1.25vw;margin-left: 0.88vw;margin-top: 0.5vw;color: black">${option}</label>
                    </div>

                `;
            });
        } else if (question.type === '填空题') {
            optionsHtml = `<input type="text" name="question_${index}" class="layui-input">`;
        } else if (question.type === '主观题') {
            optionsHtml = `<textarea name="question_${index}" class="layui-textarea"></textarea>`;
        }
        return optionsHtml;
    }

    // 提交答案
    function submitAnswers() {
        let formData = new FormData(document.forms[0]);
        paper.questions.forEach((question, index) => {
            if (typeof question !== 'string') {
                let selectedOptionIndex;
                if (question.type === '选择题' || question.type === '判断题') {
                    const options = document.querySelectorAll(`input[name="question_${index}"]`);
                    options.forEach((option, idx) => {
                        if (option.checked) {
                            selectedOptionIndex = idx + 1; // 索引加1，因为用户更习惯从1开始计数
                        }
                    });
                    answers.push(selectedOptionIndex || ''); // 如果没有选择，则推入空字符串
                } else { // 填空题或主观题
                    let answerElement = document.querySelector(`[name="question_${index}"]`);
                    let answer = answerElement ? answerElement.value : ''; // 获取答案或为空字符串
                    answers.push(answer);
            }
            }
        });
        answers.push({{ paper_id }})
        console.log(answers);
        // 发送答案到后端
        fetch('/student/submit_answers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({answers: answers})
        }).then(response => response.json())
            .then(data => {
                console.log(data);
                alert('答案提交成功！');
            }).catch(error => {
            console.error('Error:', error);
            alert('答案提交失败！');
        });
    }

    // 初始化渲染
    renderQuestions();
</script>
</body>
</html>